#!/bin/bash
set -e

function echo_usage {
	echo "usage: configure <package> <revision> [options]"
	echo "	-b <branch-rev>"
	echo "	-a <arch>"
}

# to build a package you need ...
# <package>.co: checkout commands
# <package>.cp (optional): copy step for package production
# <package>.cpp (optional): commands to setup the C++ compile environment

if [ $# -lt 2 ]
then
	echo_usage
	exit 1
fi

paket=$1
build=$2
ARCH=""
cpp_build=0

# checkout build utilities
if [ ! -d projects ]; then
	git clone https://github.com/wagner-tech/projects/
fi
ln -sf projects/tools/make/makefile .

# check standard files
if [ ! -x $paket.co ]
then
	echo "file $paket.co missing or not executable."
	exit 1
fi
if [ ! -x $paket.cp ]
then
	echo "warning: file $paket.cp missing or not executable:"
	echo "  this file is necessary for any package production."
fi

# load util functions for C/C++ - build
if [ -f $paket.cpp ]
then
	cpp_build=1
	. Make/c_configure.sh
fi

# clean dirs and check out
if [ -e $paket ]
then
	rm -rf $paket
fi
rm *.stamp || true

mkdir -p src
cwd=$(pwd)

# checkout
pushd src >/dev/null
	../$paket.co $build
popd >/dev/null

# copy package control
control=$(find src -name $paket.control)
if [ -z "$control" ]
then
	echo "warning: control file not found"
	echo "  this file is necessary for any package production."
else	
	sed "s/%BUILD%/$build/" $control >$paket.control
	echo "$paket.control written."

	# extract version
	version=$(grep Version $paket.control |sed "s/Version: //")
fi

# check for postinst
postinst=$(find src -name $paket.postinst)
if [ -n "$postinst" ]
then
	ln -sf $postinst .
fi

# create generic make.pre, if not existing
if [ ! -f make.pre ]
then
	cat  >>make.pre <<MAKE_PRE
# mBuild make.pre script (auto generated)
project = $paket
version = $version
COPY = ./$paket.cp
MAKE_PRE
	echo "make.pre written."
fi

